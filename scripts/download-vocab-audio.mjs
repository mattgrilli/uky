// Downloads Ukrainian TTS audio for vocabulary lessons.
// Run: node scripts/download-vocab-audio.mjs
// Or for a specific lesson: node scripts/download-vocab-audio.mjs numbers

import https from "https";
import fs from "fs";
import path from "path";
import { fileURLToPath } from "url";

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const audioDir = path.join(__dirname, "..", "public", "audio");

const allLessons = {
  greetings: [
    [1, "Привіт"],
    [2, "Здрастуйте"],
    [3, "Добрий ранок"],
    [4, "Добрий день"],
    [5, "Добрий вечір"],
    [6, "До побачення"],
    [7, "Бувай"],
    [8, "Так"],
    [9, "Ні"],
    [10, "Дякую"],
    [11, "Будь ласка"],
    [12, "Вибачте"],
    [13, "Як справи"],
    [14, "Добре"],
    [15, "Я не розумію"],
    [16, "Як вас звати"],
    [17, "Мене звати"],
    [18, "Приємно познайомитись"],
    [19, "Будь ласка повторіть"],
    [20, "Я вивчаю українську"],
  ],
  numbers: [
    [1, "Один"],
    [2, "Два"],
    [3, "Три"],
    [4, "Чотири"],
    [5, "П'ять"],
    [6, "Шість"],
    [7, "Сім"],
    [8, "Вісім"],
    [9, "Дев'ять"],
    [10, "Десять"],
    [11, "Одинадцять"],
    [12, "Дванадцять"],
    [13, "Тринадцять"],
    [14, "Чотирнадцять"],
    [15, "П'ятнадцять"],
    [16, "Шістнадцять"],
    [17, "Сімнадцять"],
    [18, "Вісімнадцять"],
    [19, "Дев'ятнадцять"],
    [20, "Двадцять"],
    [21, "Тридцять"],
    [22, "Сорок"],
    [23, "П'ятдесят"],
    [24, "Шістдесят"],
    [25, "Сімдесят"],
    [26, "Вісімдесят"],
    [27, "Дев'яносто"],
    [28, "Сто"],
  ],
  family: [
    [1, "Сім'я"],
    [2, "Мама"],
    [3, "Тато"],
    [4, "Батьки"],
    [5, "Син"],
    [6, "Дочка"],
    [7, "Брат"],
    [8, "Сестра"],
    [9, "Дідусь"],
    [10, "Бабуся"],
    [11, "Онук"],
    [12, "Онука"],
    [13, "Дядько"],
    [14, "Тітка"],
    [15, "Двоюрідний брат"],
    [16, "Двоюрідна сестра"],
    [17, "Чоловік"],
    [18, "Дружина"],
    [19, "Дитина"],
    [20, "Діти"],
  ],
  "common-nouns": [
    [1, "Вода"],
    [2, "Хліб"],
    [3, "Їжа"],
    [4, "Дім"],
    [5, "Місто"],
    [6, "Вулиця"],
    [7, "Машина"],
    [8, "Книга"],
    [9, "Телефон"],
    [10, "Стіл"],
    [11, "Стілець"],
    [12, "Двері"],
    [13, "Вікно"],
    [14, "Магазин"],
    [15, "Школа"],
    [16, "Робота"],
    [17, "Гроші"],
    [18, "Час"],
    [19, "День"],
    [20, "Ніч"],
  ],
  colors: [
    [1, "Червоний"],
    [2, "Синій"],
    [3, "Зелений"],
    [4, "Жовтий"],
    [5, "Білий"],
    [6, "Чорний"],
    [7, "Сірий"],
    [8, "Коричневий"],
    [9, "Помаранчевий"],
    [10, "Рожевий"],
    [11, "Фіолетовий"],
    [12, "Блакитний"],
    [13, "Золотий"],
    [14, "Срібний"],
    [15, "Темний"],
    [16, "Світлий"],
  ],
  "days-months": [
    [1, "Понеділок"],
    [2, "Вівторок"],
    [3, "Середа"],
    [4, "Четвер"],
    [5, "П'ятниця"],
    [6, "Субота"],
    [7, "Неділя"],
    [8, "Січень"],
    [9, "Лютий"],
    [10, "Березень"],
    [11, "Квітень"],
    [12, "Травень"],
    [13, "Червень"],
    [14, "Липень"],
    [15, "Серпень"],
    [16, "Вересень"],
    [17, "Жовтень"],
    [18, "Листопад"],
    [19, "Грудень"],
    [20, "Тиждень"],
  ],
  "food-drink": [
    [1, "Кава"],
    [2, "Чай"],
    [3, "Молоко"],
    [4, "Сік"],
    [5, "Пиво"],
    [6, "Вино"],
    [7, "М'ясо"],
    [8, "Риба"],
    [9, "Курка"],
    [10, "Яйце"],
    [11, "Сир"],
    [12, "Масло"],
    [13, "Рис"],
    [14, "Картопля"],
    [15, "Помідор"],
    [16, "Огірок"],
    [17, "Яблуко"],
    [18, "Цукор"],
    [19, "Сіль"],
    [20, "Борщ"],
  ],
  verbs: [
    [1, "Бути"],
    [2, "Мати"],
    [3, "Робити"],
    [4, "Йти"],
    [5, "Їхати"],
    [6, "Хотіти"],
    [7, "Могти"],
    [8, "Знати"],
    [9, "Говорити"],
    [10, "Бачити"],
    [11, "Їсти"],
    [12, "Пити"],
    [13, "Читати"],
    [14, "Писати"],
    [15, "Любити"],
    [16, "Жити"],
    [17, "Працювати"],
    [18, "Вчити"],
    [19, "Думати"],
    [20, "Давати"],
  ],
  "seasons-weather": [
    [1, "Пора року"],
    [2, "Весна"],
    [3, "Літо"],
    [4, "Осінь"],
    [5, "Зима"],
    [6, "Погода"],
    [7, "Сніг"],
    [8, "Дощ"],
    [9, "Сонце"],
    [10, "Вітер"],
    [11, "Хмара"],
    [12, "Тепло"],
    [13, "Зимно"],
    [14, "Гарячо"],
    [15, "Південь"],
    [16, "Північ"],
    [17, "Дощовик"],
    [18, "Парасоля"],
    [19, "Раптом"],
    [20, "Чекати"],
  ],
  clothing: [
    [1, "Одяг"],
    [2, "Сорочка"],
    [3, "Штани"],
    [4, "Жакет"],
    [5, "Черевики"],
    [6, "Чоботи"],
    [7, "Шапка"],
    [8, "Шалик"],
    [9, "Рукавиці"],
    [10, "Купальник"],
    [11, "Сукня"],
    [12, "Спідниця"],
    [13, "Светр"],
    [14, "Пальто"],
    [15, "Шкарпетки"],
    [16, "Краватка"],
    [17, "Легший"],
    [18, "Стягнути"],
    [19, "Одягнути"],
    [20, "Носити"],
  ],
  nature: [
    [1, "Дерева"],
    [2, "Квіти"],
    [3, "Пташки"],
    [4, "Листя"],
    [5, "Ліс"],
    [6, "Річка"],
    [7, "Озеро"],
    [8, "Гора"],
    [9, "Поле"],
    [10, "Небо"],
    [11, "Зірка"],
    [12, "Місяць"],
    [13, "Трава"],
    [14, "Тварина"],
    [15, "Кіт"],
    [16, "Собака"],
    [17, "М'яч"],
    [18, "Морозиво"],
    [19, "Плавати"],
    [20, "Сумний"],
  ],
  "ukrainian-cuisine": [
    [1, "Смачного"],
    [2, "Вареники"],
    [3, "Пироги"],
    [4, "Голубці"],
    [5, "Деруни"],
    [6, "Ковбаса"],
    [7, "Налисники"],
    [8, "Сметана"],
    [9, "Капуста"],
    [10, "Шинка"],
    [11, "Гриби"],
    [12, "Канапки"],
    [13, "Сало"],
    [14, "Каша"],
    [15, "Пампушки"],
    [16, "Буряк"],
    [17, "Часник"],
    [18, "Цибуля"],
    [19, "Рибки"],
    [20, "Мушлі"],
  ],
  "sweets-fruits": [
    [1, "Торт"],
    [2, "Печиво"],
    [3, "Цукерки"],
    [4, "Шоколад"],
    [5, "Мед"],
    [6, "Горіхи"],
    [7, "Малини"],
    [8, "Суниці"],
    [9, "Ягоди"],
    [10, "Вишня"],
    [11, "Виноград"],
    [12, "Яблуко"],
    [13, "Груша"],
    [14, "Кавун"],
    [15, "Банан"],
    [16, "Апельсин"],
    [17, "Лимон"],
    [18, "Слива"],
    [19, "Персик"],
    [20, "Диня"],
  ],
  "days-school": [
    [1, "понеділок"],
    [2, "вівторок"],
    [3, "середа"],
    [4, "четвер"],
    [5, "п'ятниця"],
    [6, "субота"],
    [7, "неділя"],
    [8, "тиждень"],
    [9, "дні тижня"],
    [10, "день"],
    [11, "школа"],
    [12, "перерва"],
    [13, "задача"],
    [14, "вчора"],
    [15, "сьогодні"],
    [16, "завтра"],
    [17, "наступний"],
    [18, "кожного"],
    [19, "вірш"],
    [20, "пісня"],
    [21, "співав"],
    [22, "грали"],
    [23, "говорили"],
    [24, "потіха"],
    [25, "почали"],
    [26, "пам'ятаю"],
    [27, "приємно"],
    [28, "наша"],
  ],
  "food-phrases": [
    [1, "обід"],
    [2, "борщ"],
    [3, "хліб"],
    [4, "горох"],
    [5, "капуста"],
    [6, "пиріжки"],
    [7, "каша"],
    [8, "яєчка"],
    [9, "курочка"],
    [10, "м'ясо"],
    [11, "м'яч"],
    [12, "страви"],
    [13, "голодний"],
    [14, "свіжий"],
    [15, "люблю"],
    [16, "забув"],
    [17, "знаю"],
    [18, "знав"],
    [19, "казала"],
    [20, "їжте"],
    [21, "наїдаймось"],
    [22, "ласо"],
    [23, "вариш"],
    [24, "пробуємо"],
    [25, "для відміни"],
    [26, "чекай"],
    [27, "ще раз"],
    [28, "то саме"],
  ],
};

function downloadTTS(text, filename) {
  return new Promise((resolve, reject) => {
    const encoded = encodeURIComponent(text);
    const url = `https://translate.google.com/translate_tts?ie=UTF-8&tl=uk&client=tw-ob&q=${encoded}`;

    const outPath = path.join(audioDir, `${filename}.mp3`);

    https.get(url, { headers: { "User-Agent": "Mozilla/5.0" } }, (res) => {
      if (res.statusCode === 302 || res.statusCode === 301) {
        https.get(res.headers.location, { headers: { "User-Agent": "Mozilla/5.0" } }, (res2) => {
          const stream = fs.createWriteStream(outPath);
          res2.pipe(stream);
          stream.on("finish", () => { stream.close(); resolve(outPath); });
        }).on("error", reject);
        return;
      }
      if (res.statusCode !== 200) {
        reject(new Error(`HTTP ${res.statusCode} for "${text}"`));
        return;
      }
      const stream = fs.createWriteStream(outPath);
      res.pipe(stream);
      stream.on("finish", () => { stream.close(); resolve(outPath); });
    }).on("error", reject);
  });
}

async function downloadLesson(lessonId, words) {
  console.log(`\n--- ${lessonId} (${words.length} words) ---`);
  for (const [idx, text] of words) {
    const filename = `vocab-${lessonId}-${String(idx).padStart(2, "0")}`;
    const outPath = path.join(audioDir, `${filename}.mp3`);

    // Skip if already downloaded
    if (fs.existsSync(outPath) && fs.statSync(outPath).size > 100) {
      console.log(`  SKIP: ${filename} (already exists)`);
      continue;
    }

    try {
      await downloadTTS(text, filename);
      console.log(`  OK: ${filename} ("${text}")`);
      await new Promise((r) => setTimeout(r, 300));
    } catch (err) {
      console.error(`  FAIL: ${filename} ("${text}"):`, err.message);
    }
  }
}

async function main() {
  fs.mkdirSync(audioDir, { recursive: true });

  const filterLesson = process.argv[2];
  const lessonsToDownload = filterLesson
    ? { [filterLesson]: allLessons[filterLesson] }
    : allLessons;

  if (filterLesson && !allLessons[filterLesson]) {
    console.error(`Unknown lesson: ${filterLesson}`);
    console.error(`Available: ${Object.keys(allLessons).join(", ")}`);
    process.exit(1);
  }

  const total = Object.values(lessonsToDownload).reduce((s, w) => s + w.length, 0);
  console.log(`Downloading audio for ${Object.keys(lessonsToDownload).length} lesson(s), ${total} words total...`);

  for (const [lessonId, words] of Object.entries(lessonsToDownload)) {
    await downloadLesson(lessonId, words);
  }

  console.log("\nDone!");
}

main();
